/*
 * xhEditor - WYSIWYG XHTML Editor
 * @requires jQuery v1.3.2(fixed)
 * 
 * @author Yanis.Wang<yanis.wang@gmail.com>
 * @site http://pirate9.com/
 * @licence LGPL(http://www.opensource.org/licenses/lgpl-license.php)
 * 
 * @Version: 0.9.1 build 090425
 */
(function(g){g.fn.xhEditor=function(B,C){return this.each(function(){if(this.tagName.toLowerCase()!="textarea"){return}if(B){if(!this.xhEditor){var D=new g.xhEditor(this,C);if(D.init()){this.xhEditor=D}else{D=null}}}else{if(this.xhEditor){this.xhEditor.remove();this.xhEditor=null}}})};var i=0,o=g.browser.msie,j=g.browser.mozilla,y=g.browser.safari,p=false;var d,m,h;var x,v;x=window.location.href.replace(/[\?#].*$/,"").replace(/[\/\\][^\/]*$/,"");x+="/";var z=g("script[src$=xheditor.js]");if(z.size()==1){v=z[0].src.replace(/[\?#].*$/,"").replace(/(^|[\/\\])[^\/]*$/,"");if(v!=""){v+="/"}}var w={27:"esc",9:"tab",32:"space",13:"return",8:"backspace",145:"scroll",20:"capslock",144:"numlock",19:"pause",45:"insert",36:"home",46:"del",35:"end",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12"};var k=["#FFFFFF","#E5E4E4","#D9D8D8","#C0BDBD","#A7A4A4","#8E8A8B","#827E7F","#767173","#5C585A","#000000","#FEFCDF","#FEF4C4","#FEED9B","#FEE573","#FFED43","#F6CC0B","#E0B800","#C9A601","#AD8E00","#8C7301","#FFDED3","#FFC4B0","#FF9D7D","#FF7A4E","#FF6600","#E95D00","#D15502","#BA4B01","#A44201","#8D3901","#FFD2D0","#FFBAB7","#FE9A95","#FF7A73","#FF483F","#FE2419","#F10B00","#D40A00","#940000","#6D201B","#FFDAED","#FFB7DC","#FFA1D1","#FF84C3","#FF57AC","#FD1289","#EC0078","#D6006D","#BB005F","#9B014F","#FCD6FE","#FBBCFF","#F9A1FE","#F784FE","#F564FE","#F546FF","#F328FF","#D801E5","#C001CB","#8F0197","#E2F0FE","#C7E2FE","#ADD5FE","#92C7FE","#6EB5FF","#48A2FF","#2690FE","#0162F4","#013ADD","#0021B0","#D3FDFF","#ACFAFD","#7CFAFF","#4AF7FE","#1DE6FE","#01DEFF","#00CDEC","#01B6DE","#00A0C2","#0084A0","#EDFFCF","#DFFEAA","#D1FD88","#BEFA5A","#A8F32A","#8FD80A","#79C101","#3FA701","#307F00","#156200","#D4C89F","#DAAD88","#C49578","#C2877E","#AC8295","#C0A5C4","#969AC2","#92B7D7","#80ADAF","#9CA53B"];var c=["宋体","黑体","楷体","隶书","幼圆","Arial","Arial Narrow","Arial Black","Comic Sans MS","Courier","System","Times New Roman","Verdana"];var s=[{n:"xx-small",wkn:"x-small",s:"8pt",t:"8"},{n:"x-small",wkn:"small",s:"10pt",t:"10"},{n:"small",wkn:"medium",s:"12pt",t:"12"},{n:"medium",wkn:"large",s:"14pt",t:"14"},{n:"large",wkn:"x-large",s:"16pt",t:"16"},{n:"x-large",wkn:"xx-large",s:"20pt",t:"20"},{n:"xx-large",wkn:"-webkit-xxx-large",s:"24pt",t:"24"}];var e=[{s:"左对齐",v:"justifyleft",t:"左对齐"},{s:"居中",v:"justifycenter",t:"居中"},{s:"右对齐",v:"justifyright",t:"右对齐"},{s:"两端对齐",v:"justifyfull",t:"两端对齐"}],f=[{s:"数字列表",v:"insertOrderedList",t:"数字列表"},{s:"符号列表",v:"insertunorderedlist",t:"符号列表"}];var a='<div>使用键盘快捷键(Ctrl+V)把内容粘贴到方框里，按 确定</div><div><textarea id="xhEdtPastetextValue" wrap="soft" spellcheck="false" style="width:300px;height:100px;" /></div><div style="text-align:right;"><input type="button" id="xhEdtSave" value="确定" /></div>';var b='<div>链接地址: <input type="text" id="xhEdtLinkHref" value="http://" /></div><div>打开方式: <select id="xhEdtLinkTarget"><option selected="selected" value="">默认</option><option value="_blank">新窗口</option><option value="_self">当前窗口</option><option value="_parent">父窗口</option></select></div><div style="text-align:right;"><input type="button" id="xhEdtSave" value="确定" /></div>';var u='<div>图片地址：<input type="text" id="xhEdtImgSrc" value="http://" /></div><div>替换文本：<input type="text" id="xhEdtImgAlt" /></div><div>对齐方式：<select id="xhEdtImgAlign"><option selected="selected" value="">默认</option><option value="left">左对齐</option><option value="right">右对齐</option><option value="top">顶端</option><option value="middle">居中</option><option value="baseline">基线</option><option value="bottom">底边</option></select></div><div>宽度高度：<input type="text" id="xhEdtImgWidth" style="width:40px;" /> x <input type="text" id="xhEdtImgHeight" style="width:40px;" /></div><div>边框大小：<input type="text" id="xhEdtImgBorder" style="width:40px;" /></div><div>水平间距：<input type="text" id="xhEdtImgVspace" style="width:40px;" /> 垂直间距：<input type="text" id="xhEdtImgHspace" style="width:40px;" /></div><div style="text-align:right;"><input type="button" id="xhEdtSave" value="确定" /></div>';var A='<div>动画地址：<input type="text" id="xhEdtFlashSrc" value="http://" /></div><div>宽度高度：<input type="text" id="xhEdtFlashWidth" style="width:40px;" value="412" /> x <input type="text" id="xhEdtFlashHeight" style="width:40px;" value="300" /></div><div style="text-align:right;"><input type="button" id="xhEdtSave" value="确定" /></div>';var t='<div>视频地址：<input type="text" id="xhEdtMediaSrc" value="http://" /></div><div>宽度高度：<input type="text" id="xhEdtMediaWidth" style="width:40px;" value="412" /> x <input type="text" id="xhEdtMediaHeight" style="width:40px;" value="300" /></div><div style="text-align:right;"><input type="button" id="xhEdtSave" value="确定" /></div>';var n='<div style="width:100px;word-wrap:break-word;word-break:break-all;"><p>版本：V1.0</p></div><div style="text-align:right;"><input type="button" id="xhEdtSave" value="确定" /></div>';var l=[{t:"Big grin",s:"biggrin.gif"},{t:"Smile",s:"smile.gif"},{t:"Titter",s:"titter.gif"},{t:"Lol",s:"lol.gif"},{t:"Call",s:"call.gif"},{t:"Victory",s:"victory.gif"},{t:"Shy",s:"shy.gif"},{t:"Handshake",s:"handshake.gif"},{t:"Kiss",s:"kiss.gif"},{t:"Sad",s:"sad.gif"},{t:"Cry",s:"cry.gif"},{t:"Huffy",s:"huffy.gif"},{t:"Mad",s:"mad.gif"},{t:"Tongue",s:"tongue.gif"},{t:"Sweat",s:"sweat.gif"},{t:"Shocked",s:"shocked.gif"},{t:"Time",s:"time.gif"},{t:"Hug",s:"hug.gif"}];var r={GStart:{},GEnd:{},Separator:{},Cut:{t:"剪切 (Ctrl+X)"},Copy:{t:"复制 (Ctrl+C)"},Paste:{t:"粘贴 (Ctrl+V)"},Pastetext:{t:"粘贴文本"},Fontface:{t:"字体"},FontSize:{t:"字号"},Bold:{t:"加粗 (Ctrl+B)",s:"Ctrl+B"},Italic:{t:"斜体 (Ctrl+I)",s:"Ctrl+I"},Underline:{t:"下划线 (Ctrl+U)",s:"Ctrl+U"},Strikethrough:{t:"中划线 (Ctrl+S)",s:"Ctrl+S"},FontColor:{t:"字体颜色"},BackColor:{t:"背景颜色"},Removeformat:{t:"删除文字格式"},Align:{t:"对齐"},List:{t:"编号"},Outdent:{t:"减少缩进"},Indent:{t:"增加缩进"},Link:{t:"超链接"},Unlink:{t:"取消超链接"},Img:{t:"图片"},Flash:{t:"Flash动画"},Media:{t:"视频"},Emot:{t:"表情"},Html:{t:"Html源代码 (Ctrl+H)",s:"Ctrl+H"},Preview:{t:"预览"},Fullscreen:{t:"全屏编辑 (Esc)",s:"Esc"},About:{t:"网页编辑器"}};var q={mini:"GStart,Bold,Italic,Underline,Strikethrough,GEnd,Separator,GStart,Align,List,GEnd,Separator,GStart,Link,Img,About,GEnd",simple:"GStart,Fontface,FontSize,Bold,Italic,Underline,Strikethrough,FontColor,BackColor,GEnd,Separator,GStart,Align,List,Outdent,Indent,GEnd,Separator,GStart,Link,Img,Emot,About,GEnd",full:"GStart,Cut,Copy,Paste,Pastetext,GEnd,Separator,GStart,Fontface,FontSize,Bold,Italic,Underline,Strikethrough,FontColor,BackColor,Removeformat,GEnd,Separator,GStart,Align,List,Outdent,Indent,GEnd,Separator,GStart,Link,Unlink,Img,Flash,Media,Emot,GEnd,Separator,GStart,Html,Preview,Fullscreen,About,GEnd"};g.xhEditor=function(P,G){var M={skin:"default",tools:"full",clearScript:true,clearStyle:true};var U=this,D=P,V=g(D),J=V.closest("form"),N,L,aa,E,S;var K;var O=false,F=false,C=false,Z=false,R="",Y;var X=g.extend({},M,G);if(X.tools.match(/^\s*(mini|simple|full)\s*$/i)){X.tools=g.trim(X.tools);X.tools=q[X.tools]}if(!X.tools.match(/(^|,)\s*About\s*(,|$)/i)){X.tools+=",About"}X.tools=X.tools.split(",");var I="xhEdtCSS_"+X.skin,T="xhEdt"+i+"_container",B="xhEdt"+i+"_Tool",Q="xhEdt"+i+"_iframearea",W="xhEdt"+i+"_iframe";var H=[];this.init=function(){if(g("#"+I).size()==0){g("head").append('<link id="'+I+'" rel="stylesheet" type="text/css" href="'+v+"xheditor_skin/"+X.skin+'/ui.css" />')}var ab=X.width||D.style.width||D.offsetWidth,ae=X.height||D.style.height||D.offsetHeight;var ad=/^[0-9\.]+(|px)$/i;if(ad.test(""+ab)){ab+="px"}var ag=24;V.after(g('<span id="'+T+'" class="xhEdt_'+X.skin+'" style="display:none"><table cellspacing="0" cellpadding="0" class="xhEdtLayout" style="width:'+ab+";height:"+ae+'px;"><tbody><tr><td id="'+B+'" class="xhEdtTool" style="height:'+ag+'px"></td></tr><tr><td id="'+Q+'"class="xhEdtIframeArea"><iframe frameborder="0" id="'+W+'" src="javascript:;" style="width:100%" /></td></tr></tbody></table></span>'));L=g("#"+W)[0].contentWindow;aa=g(L);try{E=L.document;S=g(E);E.open();E.write('<html><head><base href="'+x+'"/><meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/><link rel="stylesheet" href="'+v+"xheditor_skin/"+X.skin+'/iframe.css"/>');if(X.loadCSS){E.write('<link rel="stylesheet" href="'+X.loadCSS+'"/>')}E.write('</head><body dir="ltr" spellcheck="false" class="editMode"></body></html>');E.close();if(o){E.body.contentEditable="true"}else{E.designMode="On";setTimeout(U.setOpts,300)}U.setHTML()}catch(ah){}var af="",ac;af+='<table cellspacing="0" cellpadding="0"><tbody><tr>';g.each(X.tools,function(ai,aj){ac=r[aj];if(aj=="GStart"){af+='<td><span class="xhEdtGStart"/></td>'}else{if(aj=="GEnd"){af+='<td><span class="xhEdtGEnd"/></td>'}else{if(aj=="Separator"){af+='<td><span class="xhEdtSeparator"/></td>'}else{af+='<td><a href="javascript:;" title="'+ac.t+'" name="'+aj+'" class="xhEdtButton xhEdtEnabled"><span class="xhEdtIcon xhEdtBtn'+aj+'"/></a></td>';if(ac.s){U.addShortCut(ac.s,aj)}}}}});af+="</tr></tbody></table>";N=g("#"+B).append(af).click(function(){U.focus()});N.find(".xhEdtButton").click(function(aj){U.hidePanel();U.focus();Y=aj;var ai=g(this);if(ai.is(".xhEdtEnabled")){U.exec(ai.attr("name"))}Y.stopPropagation()}).mousedown(function(){return false});d=g("#xhEdtPanel");m=g("#xhEdtCntLine");if(d.size()==0){d=g('<div id="xhEdtPanel"></div>').mousedown(function(ai){ai.stopPropagation()});m=g('<div id="xhEdtCntLine"><img src="'+v+"xheditor_skin/"+X.skin+'/img/spacer.gif" /></div>');g(document.body).append(d).append(m)}g(document).mousedown(U.hidePanel);S.mousedown(U.hidePanel);if(o){S.bind("beforedeactivate",function(){if(!F){K=U.getRng()}});aa.focus(function(){if(K&&!F){K.select();K=null}})}g("#"+T).show();V.hide();U.bind();i++;if(X.fullscreen){U.toggleFullscreen()}O=true;return true};this.remove=function(){U.unbind();g("#"+T).remove();V.show();O=false};this.bind=function(){aa.blur(U.getHTML);if(y){aa.click(U.fixAppleSel)}J.submit(U.getHTML).bind("reset",U.setHTML);var ab=g(window);ab.unload(U.getHTML).bind("beforeunload",U.getHTML);ab.resize(U.fixFullHeight);S.keydown(U.checkShortCut)};this.unbind=function(){aa.unbind("blur",U.getHTML);if(y){aa.unbind("click",U.fixAppleSel)}J.unbind("submit",U.getHTML).unbind("reset",U.setHTML);var ab=g(window);ab.unbind("unload",U.getHTML).unbind("beforeunload",U.getHTML);ab.unbind("resize",U.fixFullHeight);S.unbind("keydown",U.checkShortCut)};this.setCSS=function(ab){try{U._exec("styleWithCSS",ab)}catch(ac){U._exec("useCSS",!ab)}};this.setOpts=function(){if(O){U.setCSS(false);try{U._exec("enableObjectResizing",true)}catch(ab){}try{U._exec("enableInlineTableEditing",false)}catch(ab){}if(o){try{U._exec("BackgroundImageCache",true)}catch(ab){}}}};this.fixFullHeight=function(){if(!j&&!y){var ab=g("#idIframeArea");ab.height("100%");if(Z){ab.height((ab.height()-30)+"px")}}};this.fixAppleSel=function(ad){ad=ad.target;if(ad.tagName.match(/(img|embed)/i)){var ac=U.getSel(),ab=E.createRange();ab.selectNode(ad);ac.removeAllRanges();ac.addRange(ab)}};this.focus=function(){if(!F){aa.focus()}else{g("#htmlSource",E).focus()}};this.getSel=function(){return L.getSelection?L.getSelection():E.selection};this.getRng=function(){var ad=U.getSel(),ab;try{ab=ad.rangeCount>0?ad.getRangeAt(0):(ad.createRange?ad.createRange():E.createRange())}catch(ac){}if(!ab){ab=o?E.body.createTextRange():E.createRange()}return ab};this.getParent=function(ab){var ac=U.getRng(),ad;if(!o){ad=ac.commonAncestorContainer;if(!ac.collapsed){if(ac.startContainer==ac.endContainer&&ac.startOffset-ac.endOffset<2&&ac.startContainer.hasChildNodes()){ad=ac.startContainer.childNodes[ac.startOffset]}}}else{ad=ac.item?ac.item(0):ac.parentElement()}ab=ab?ab:"*";ad=g(ad);if(!ad.is(ab)){ad=g(ad).closest(ab)}return ad};this.pasteHTML=function(ac){if(F||C){return false}U.focus();var ab=U.getRng();if(ab.insertNode){ab.deleteContents();ab.insertNode(ab.createContextualFragment(ac))}else{if(ab.item){U._exec("delete");ab=U.getRng()}ab.pasteHTML(ac)}};this.pasteText=function(ab){if(!ab){ab=""}ab=U.domEncode(ab);ab=ab.replace(/\r?\n/g,"<br />");U.pasteHTML(ab)};this.domEncode=function(ac){if(ac){var ab={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};ac=ac.replace(/[&"<>]/g,function(ad){return ab[ad]})}return ac};this.setHTML=function(ab){setTimeout(function(){K=null;if(typeof ab!="string"&&ab!=""){ab=V.val()}ab=U.formatXHTML(ab);if(F){g("#htmlSource",E).val(ab)}else{g(E.body)[0].innerHTML=U.processHTML(ab,"write")}},10)};this.processHTML=function(af,ae){var ab=' class="Apple-style-span"';if(ae=="write"){if(j){af=af.replace(/<(\/?)strong( [^>]+)?>/ig,"<$1b$2>");af=af.replace(/<(\/?)em( [^>]+)?>/ig,"<$1i$2>")}else{if(y){af=af.replace(/("|;)\s*font-size\s*:\s*([a-z-]+);/ig,function(ak,al,ag){var ai,aj;for(var ah=0;ah<s.length;ah++){ai=s[ah];if(ag==ai.n){aj=ai.wkn;break}}return al+"font-size:"+aj});af=af.replace(/<(\/?)strong( [^>]+)?>/ig,"<$1span"+ab+' style="font-weight: bold;"$2>');af=af.replace(/<(\/?)em( [^>]+)?>/ig,"<$1span"+ab+' style="font-style: italic;"$2>');af=af.replace(/<(\/?)u( [^>]+)?>/ig,"<$1span"+ab+' style="text-decoration: underline;"$2>');af=af.replace(/<(\/?)strike( [^>]+)?>/ig,"<$1span"+ab+' style="text-decoration: line-through;"$2>');af=af.replace(/<span((?:\s+[^>]+)?\s+style="([^"]*;)*\s*(font-family|font-size|color|background-color)\s*:\s*[^;"]+\s*;?"[^>]*)>/ig,"<span"+ab+"$1>")}else{if(o){af=af.replace(/&apos;/ig,"&#39;");af=af.replace(/\s+(disabled|checked|readonly|selected)\s*=\s*[\"\']?(false|0)[\"\']?/ig,"")}}}af=af.replace(/<a(\s+[^>]+)?\/>/,"<a$1></a>");if(!y){for(var ac=0;ac<3;ac++){af=af.replace(/<(span)(?:\s+[^>]+)? style="((?:[^"]*?;)*\s*(?:font-family|font-size|color)\s*:[^"]*)"(?: [^>]+)?>(((?!<\1>)[\s\S]|<\1>((?!<\1>)[\s\S]|<\1>((?!<\1>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,function(al,ap,ag,aj){var ao="",ai,an,am,ak;ai=ag.match(/font-family\s*:\s*([^;"]+)/i);if(ai){ao+=' face="'+ai[1]+'"'}an=ag.match(/font-size\s*:\s*([a-z-]+)/i);if(an){for(var ah=0;ah<s.length;ah++){if(an[1]==s[ah].n){am=ah+1;break}}ag=ag.replace(/(^|;)(\s*font-size\s*:\s*[^;"]+;?)+/ig,"$1")}if(am){ao+=' size="'+am+'"'}ak=ag.match(/color\s*:\s*([^;"]+)/i);if(ak){ao+=' color="'+ak[1]+'"'}ag=ag.replace(/(^|;)(\s*(font-family|color)\s*:\s*[^;"]+;?)+/ig,"$1");if(ao!=""){if(ag){ao+=' style="'+ag+'"'}return"<font"+ao+">"+aj+"</font>"}else{return al}})}}}else{if(y){af=af.replace(/("|;)\s*font-size\s*:\s*([a-z-]+);/ig,function(ak,al,ag){var ai,aj;for(var ah=0;ah<s.length;ah++){ai=s[ah];if(ag==ai.wkn){aj=ai.n;break}}return al+"font-size:"+aj});var ad=[{r:/font-weight:\sbold/ig,t:"strong"},{r:/font-style:\sitalic/ig,t:"em"},{r:/text-decoration:\sunderline/ig,t:"u"},{r:/text-decoration:\sline-through/ig,t:"strike"}];for(var ac=0;ac<6;ac++){af=af.replace(/<(span)(\s+[^>]+|)? class="Apple-style-span"(\s+[^>]+|)?>(((?!<\1>)[\s\S]|<\1>((?!<\1>)[\s\S]|<\1>((?!<\1>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,function(am,ah,aj,ai,an){var ag=aj+ai,al="";for(var ak=0;ak<ad.length;ak++){if(ag.match(ad[ak].r)){al=ad[ak].t;break}}if(al){return"<"+al+">"+an+"</"+al+">"}else{return am}})}}af=af.replace(/\s*(-moz-|-webkit-)[^=]+?=\s*"[^"]*"/ig,"");af=af.replace(/<(\w+[^>]*?)\s+class="?(?:apple|webkit)\-[^ >]*([^>]*?)>/ig,"<$1$2>")}return af};this.getHTML=function(){var ab;if(F){ab=g("#htmlSource",E).val()}else{ab=U.processHTML(g(E.body).html(),"read");ab=U.cleanWord(ab)}ab=U.cleanHTML(ab);ab=U.formatXHTML(ab);V.val(ab);return ab};this.cleanWord=function(ab){if(ab.match(/class="?mso/i)){ab=ab.replace(/<!--([\s\S]*?)-->|<style(\s+[^>]+)?>[\s\S]*?<\/style>/ig,"");ab=ab.replace(/<(meta|link)(\s+[^>]+)?>/ig,"");ab=ab.replace(/<\??xml(:\w+)?( [^>]+)?>([\s\S]*?<\/xml>)?/ig,"");ab=ab.replace(/<\/?\w+:[^>]*>/ig,"");ab=ab.replace(/<(\w+[^>]*?)\s+class="?mso[^ >]*([^>]*?)>/ig,"<$1$2>");ab=ab.replace(/<(\w+[^>]*?)\s+lang="?[^ \>]*([^>]*?)>/ig,"<$1$2>");ab=ab.replace(/<(\w+[^>]*?)\s+align="?left"?([^>]*?)>/ig,"<$1$2>");ab=ab.replace(/\s*mso-[^:]+:[^;"]+;?\s*/ig,"");ab=ab.replace(/\s*margin: 0cm 0cm 0pt\s*;\s*/ig,"");ab=ab.replace(/\s*margin: 0cm 0cm 0pt\s*"/ig,'"');ab=ab.replace(/\s*text-align:[^;"]+;?\s*/ig,"");ab=ab.replace(/\s*font-variant:[^;"]+;?\s*/ig,"");ab=ab.replace(/<(\w+[^>]*?) style="?"?( |>)/ig,"<$1$2")}return ab};this.cleanHTML=function(ac){if(X.clearScript){ac=ac.replace(/<script(\s+[^>]+)?>[\s\S]*?<\/script>/ig,"")}if(X.clearStyle){ac=ac.replace(/<style(\s+[^>]+)?>[\s\S]*?<\/style>/ig,"")}for(var ab=0;ab<3;ab++){ac=ac.replace(/<(span|strong|b|u|strike|em|i)(\s+[^>]+)?>((?!<\1)[ \t\r\n])*?<\/\1>/ig,"")}for(var ab=0;ab<3;ab++){ac=ac.replace(/<(span)>(((?!<\1>)[\s\S]|<\1>((?!<\1>)[\s\S]|<\1>((?!<\1>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,"$2")}ac=ac.replace(/<(p|div)(?:\s+[^>]+)?>(((?!<\1(?: [^>]+)?>)[\s\S])+?)<\/\1>/ig,function(af,ad,ag){var ae=ag.replace(/<\/?(span|strong|b|u|strike|em|i)(\s+[^>]+)?>/ig,"");ae=ae.replace(/([ \t\r\n]|&nbsp;)+/ig,"");if(ae!=""){return af}else{return"<"+ad+"></"+ad+">"}});ac=ac.replace(/^\s+/g,"");ac=ac.replace(/[\r\n]+/g,"\r\n");ac=ac.replace(/\s+$/g,"");return ac};this.formatXHTML=function(ao){var aj=am("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed");var ad=am("address,applet,blockquote,button,center,dd,del,dir,div,dl,dt,fieldset,form,frameset,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,p,pre,script,table,tbody,td,tfoot,th,thead,tr,ul");var ab=am("a,abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var");var ax=am("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr");var ak=am("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected");var aw=am("script,style");var ac={b:"strong",i:"em",s:"strike"};var ar=/^<(\w+(?:\:\w+)?)((?:\s+[\w-(?:\:\w+)?]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/;var ah=/^<\/(\w+(?:\:\w+)?)[^>]*>/;var aq=/([\w-(?:\:\w+)?]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g;var af,an,ae=[],ai=ao,al="",ap=[];ae.last=function(){return this[this.length-1]};while(ao){an=true;if(!ae.last()||!aw[ae.last()]){if(ao.indexOf("<!")==0){match=ao.match(/^<!(?:--)?(.*?)(?:--)?>/);if(match){ao=ao.substring(match[0].length);ap.push("<!--"+match[1]+"-->");an=false}}else{if(ao.indexOf("</")==0){match=ao.match(ah);if(match){ao=ao.substring(match[0].length);match[0].replace(ah,at);an=false}}else{if(ao.indexOf("<")==0){match=ao.match(ar);if(match){ao=ao.substring(match[0].length);match[0].replace(ar,au);an=false}}}}if(an){af=ao.indexOf("<");al=af<0?ao:ao.substring(0,af);ao=af<0?"":ao.substring(af);ap.push(al)}}else{ao=ao.replace(/^([\s\S]*?)<\/(?:style|script)>/i,function(ay,az){ap.push(az);return""});at("",ae.last())}if(ao==ai){at();return ap.join("")}ai=ao}at();function am(aB){var aA={},ay=aB.split(",");for(var az=0;az<ay.length;az++){aA[ay[az]]=true}return aA}function ag(az){if(az){az=az.toLowerCase();var ay=ac[az];if(ay){az=ay}}else{az=""}return az}function au(ay,aA,aB,az){aA=ag(aA);if(ad[aA]){while(ae.last()&&ab[ae.last()]){at("",ae.last())}}if(ax[aA]&&ae.last()==aA){at("",aA)}az=aj[aA]||!!az;if(!az){ae.push(aA)}ap.push("<"+aA);aB.replace(aq,function(aD,aC){aC=aC.toLowerCase();var aE=arguments[2]?arguments[2]:arguments[3]?arguments[3]:arguments[4]?arguments[4]:ak[aC]?aC:"";if(aE){ap.push(" "+aC+'="'+aE.replace(/(^|[^\\])"/g,'$1\\"')+'"')}});ap.push((az?"/":"")+">")}function at(ay,aA){if(!aA){var aB=0}else{aA=ag(aA);for(var aB=ae.length-1;aB>=0;aB--){if(ae[aB]==aA){break}}}if(aB>=0){for(var az=ae.length-1;az>=aB;az--){ap.push("</"+ae[az]+">")}ae.length=aB}}ao=ap.join("");for(var av=0;av<3;av++){ao=ao.replace(/<(font)(\s+[^>]+|)?>(((?!<\1>)[\s\S]|<\1>((?!<\1>)[\s\S]|<\1>((?!<\1>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,function(aC,aG,aD,aA){var aE="",az,aF,aB,ay;az=aD.match(/ face\s*=\s*"\s*([^"]+)\s*"/i);if(az){aE+="font-family:"+az[1]+";"}aF=aD.match(/ size\s*=\s*"\s*(\d+)\s*"/i);if(aF){aE+="font-size:"+s[aF[1]-1].n+";"}aB=aD.match(/ color\s*=\s*"\s*([^"]+)\s*"/i);if(aB){aE+="color:"+aB[1]+";"}ay=aD.match(/ style\s*=\s*"\s*([^"]+)\s*"/i);if(ay){aE+=ay[1]}if(aE){aA='<span style="'+aE+'">'+aA+"</span>"}return aA})}return ao};this.toggleHtml=function(ac){if(C||F===ac){return}if(p){U.hidePanel()}var ab=g(E.body),ae=U.getHTML();if(!F){if(o){E.body.contentEditable="false"}else{E.designMode="Off"}ab.attr("scroll","no").attr("class","sourceMode").html('<textarea id="htmlSource" wrap="soft" spellcheck="false" />');var ad=ab.find("#htmlSource");ad.val(ae).blur(U.getHTML)}else{if(o){E.body.contentEditable="true"}else{E.designMode="On";setTimeout(U.setOpts,300)}ab.removeAttr("scroll").attr("class","editMode");ab[0].innerHTML=U.processHTML(ae,"write")}F=!F;N.find("[name=Html]").toggleClass("xhEdtActive");N.find(".xhEdtButton").not("[name=Html],[name=Fullscreen]").toggleClass("xhEdtEnabled")};this.togglePreview=function(ac){if(F||C===ac){return}var ab=g(E.body);if(!C){if(o){E.body.contentEditable="false"}else{E.designMode="Off"}ab.attr("class","previewMode");ab[0].innerHTML=ab.html()}else{if(o){E.body.contentEditable="true"}else{E.designMode="On";setTimeout(U.setOpts,300)}ab.attr("class","editMode");ab[0].innerHTML=ab.html()}C=!C;N.find("[name=Preview]").toggleClass("xhEdtActive");N.find(".xhEdtButton").not("[name=Preview],[name=Fullscreen]").toggleClass("xhEdtEnabled")};this.toggleFullscreen=function(ad){if(Z===ad){return}if(p){U.hidePanel()}var ac=g("#"+T).find(".xhEdtLayout"),ab=g("#"+T);if(Z){ac.attr("style",R);g(".xhEdtIframeArea").height("100%")}else{R=ac.attr("style");ac.removeAttr("style");setTimeout(U.fixFullHeight,100)}Z=!Z;ab.toggleClass("xhEdt_Fullscreen");g("html").toggleClass("xhEdt_Fullfix");N.find("[name=Fullscreen]").toggleClass("xhEdtActive")};this.addShortCut=function(ab,ac){H[ab.toLowerCase()]=ac};this.checkShortCut=function(ad){if(F){return true}Y=ad;var ac=Y.which,ab=w[ac],ae=ab?ab:String.fromCharCode(ac).toLowerCase();sKey="";sKey+=Y.ctrlKey?"ctrl+":"";sKey+=Y.altKey?"alt+":"";sKey+=Y.shiftKey?"shift+":"";sKey+=ae;if(H[sKey]){U.exec(H[sKey]);return false}};this.showMenu=function(ad,ae){var ac=g('<div class="xhEdtMenu"></div>'),ab;g.each(ad,function(ag,af){ab=g('<a href="javascript:;" title="'+af.t+'">'+af.s+"</a>").click(function(){U.focus();ae(af.v);U.hidePanel()}).mousedown(function(){return false});ac.append(ab)});U.showPanel(ac)};this.showColor=function(af){var ac=g('<div class="xhEdtColor"></div>'),ad,ab,ae=0;ad=g("<div></div>");g.each(k,function(ah,ag){ae++;ab=g('<a href="javascript:;" title="'+ag+'" style="background:'+ag+'"><img src="'+v+"xheditor_skin/"+X.skin+'/img/spacer.gif" /></a>').click(function(){U.focus();af(ag);U.hidePanel()}).mousedown(function(){return false});ad.append(ab);if(ae%10==0){ac.append(ad);ad=g("<div></div>")}});ac.append(ad);U.showPanel(ac)};this.showPastetext=function(){var ac=g('<div class="xhEdtDialog"></div>');ac.append(a);var ad=g("#xhEdtPastetextValue",ac),ab=g("#xhEdtSave",ac);ab.click(function(){U.focus();var ae=ad.val();if(ae){U.pasteText(ae)}U.hidePanel();return false});U.showPanel(ac)};this.showLink=function(){var ac=g('<div class="xhEdtDialog"></div>');ac.append(b);var ad=U.getParent("a"),af=g("#xhEdtLinkHref",ac),ae=g("#xhEdtLinkTarget",ac),ab=g("#xhEdtSave",ac);if(ad.size()==1){af.val(ad.attr("href"));ae.attr("value",ad.attr("target"))}ab.click(function(){U.focus();var ag=af.val();if(ag==""||ad.size()==0){U._exec("unlink")}if(ag!=""){if(ad.size()==0){U._exec("createlink","#xhedt_tempurl");ad=g('a[href$="#xhedt_tempurl"]',E)}ad.attr("href",ag);if(ae.val()!=""){ad.attr("target",ae.val())}else{ad.removeAttr("target")}}U.hidePanel();return false});U.showPanel(ac)};this.showImg=function(){var aj=g('<div class="xhEdtDialog"></div>');aj.append(u);var ad=U.getParent("img"),ae=g("#xhEdtImgSrc",aj),ak=g("#xhEdtImgAlt",aj),am=g("#xhEdtImgAlign",aj),af=g("#xhEdtImgWidth",aj),ag=g("#xhEdtImgHeight",aj),al=g("#xhEdtImgBorder",aj),ab=g("#xhEdtImgVspace",aj),ah=g("#xhEdtImgHspace",aj),ai=g("#xhEdtSave",aj);if(ad.size()==1){ae.val(ad.attr("src"));ak.val(ad.attr("alt"));am.val(ad.attr("align"));af.val(ad.attr("width"));ag.val(ad.attr("height"));al.val(ad.attr("border"));var ac=ad.attr("vspace"),an=ad.attr("hspace");ab.val(ac<0?0:ac);ah.val(an<0?0:an)}ai.click(function(){U.focus();var ao=ae.val();if(ao!=""){if(ad.size()==0){U._exec("insertimage","#xhedt_tempurl");ad=g('img[src$="#xhedt_tempurl"]',E)}ad.attr("src",ao);if(ak.val()!=""){ad.attr("alt",ak.val())}else{ad.removeAttr("alt")}if(am.val()!=""){ad.attr("align",am.val())}else{ad.removeAttr("align")}if(af.val()!=""){ad.attr("width",af.val())}else{ad.removeAttr("width")}if(ag.val()!=""){ad.attr("height",ag.val())}else{ad.removeAttr("height")}if(al.val()!=""){ad.attr("border",al.val())}else{ad.removeAttr("border")}if(ab.val()!=""){ad.attr("vspace",ab.val())}else{ad.removeAttr("vspace")}if(ah.val()!=""){ad.attr("hspace",ah.val())}else{ad.removeAttr("hspace")}}else{if(ad.size()==1){ad.remove()}}U.hidePanel();return false});U.showPanel(aj)};this.showFlash=function(){var ad=g('<div class="xhEdtDialog"></div>');ad.append(A);var ae=U.getParent('embed[classid="clsid:d27cdb6e-ae6d-11cf-96b8-4445535400000"]'),ag=g("#xhEdtFlashSrc",ad),af=g("#xhEdtFlashWidth",ad),ab=g("#xhEdtFlashHeight",ad),ac=g("#xhEdtSave",ad);if(ae.size()==1){ag.val(ae.attr("src"));af.val(ae.attr("width"));ab.val(ae.attr("height"))}ac.click(function(){U.focus();var ai=ag.val();if(ai!=""){if(ae.size()==0){U.pasteHTML('<embed tyle="application/x-shockwave-flash" classid="clsid:d27cdb6e-ae6d-11cf-96b8-4445535400000" src="#xhedt_tempurl" wmode="opaque" quality="high" bgcolor="#ffffff" menu="false" play="true" loop="true" />');ae=g('embed[src$="#xhedt_tempurl"]',E)}ae.attr("src",ai);var ah=af.val(),ak=ab.val(),aj=/^[0-9]+$/;if(!aj.test(ah)){ah=412}if(!aj.test(ak)){ak=300}ae.attr("width",ah);ae.attr("height",ak)}else{if(ae.size()==1){ae.remove()}}U.hidePanel();return false});U.showPanel(ad)};this.showMeida=function(){var ag=g('<div class="xhEdtDialog"></div>');ag.append(t);var ad=U.getParent('embed[classid="clsid:6bf52a52-394a-11d3-b153-00c04f79faa6"]'),af=g("#xhEdtMediaSrc",ag),ae=g("#xhEdtMediaWidth",ag),ab=g("#xhEdtMediaHeight",ag),ac=g("#xhEdtSave",ag);if(ad.size()==1){af.val(ad.attr("src"));ae.val(ad.attr("width"));ab.val(ad.attr("height"))}ac.click(function(){U.focus();var ai=af.val();if(ai!=""){if(ad.size()==0){U.pasteHTML('<embed type="application/x-mplayer2" classid="clsid:6bf52a52-394a-11d3-b153-00c04f79faa6" src="#xhedt_tempurl" enablecontextmenu="false" autostart="false" />');ad=g('embed[src$="#xhedt_tempurl"]',E)}ad.attr("src",ai);var ah=ae.val(),ak=ab.val(),aj=/^[0-9]+$/;if(!aj.test(ah)){ah=412}if(!aj.test(ak)){ak=300}ad.attr("width",ah);ad.attr("height",ak)}else{if(ad.size()==1){ad.remove()}}U.hidePanel();return false});U.showPanel(ag)};this.showEmot=function(){var af=g('<div class="xhEdtEmot"></div>'),ad,ab,ae=0,ac=v+"xheditor_emot/";ad=g("<div></div>");g.each(l,function(ah,ag){ae++;ab=g('<a href="javascript:;" title="'+ag.t+'"><img src="'+ac+ag.s+'" /></a>').click(function(){U.focus();U._exec("insertimage",ac+ag.s);U.hidePanel()}).mousedown(function(){return false});ad.append(ab);if(ae%6==0){af.append(ad);ad=g("<div></div>")}});af.append(ad);U.showPanel(af)};this.showAbout=function(){var ac=g('<div class="xhEdtDialog"></div>');ac.append(n);var ab=g("#xhEdtSave",ac);ab.click(function(){U.focus();U.hidePanel();return false});U.showPanel(ac)};this.showPanel=function(ac){if(p){U.hidePanel()}d.empty().append(ac);h=g(Y.target).closest("a");var ad=h.offset();var ab=ad.left,ae=ad.top;ae+=h.height();h.addClass("xhEdtActive");m.css("left",ab+1).css("top",ae).show();d.css("left",ab).css("top",ae).show();p=true};this.hidePanel=function(){if(p){h.removeClass("xhEdtActive");m.hide();d.hide();p=false}};this.exec=function(ae){ae=ae.toLowerCase();switch(ae){case"cut":try{E.execCommand(ae);if(!E.queryCommandSupported(ae)){throw"Error"}}catch(ad){alert("您的浏览器安全设置不允许使用剪切操作，请使用键盘快捷键(Ctrl + X)来完成")}break;case"copy":try{E.execCommand(ae);if(!E.queryCommandSupported(ae)){throw"Error"}}catch(ad){alert("您的浏览器安全设置不允许使用复制操作，请使用键盘快捷键(Ctrl + C)来完成")}break;case"paste":try{E.execCommand(ae);if(!E.queryCommandSupported(ae)){throw"Error"}}catch(ad){alert("您的浏览器安全设置不允许使用粘贴操作，请使用键盘快捷键(Ctrl + V)来完成")}break;case"pastetext":if(window.clipboardData){U.pasteText(window.clipboardData.getData("Text",true))}else{U.showPastetext()}break;case"fontface":var ab=[];g.each(c,function(ag,af){ab.push({s:'<span style="font-family:'+af+'">'+af+"</span>",v:af,t:af})});U.showMenu(ab,function(af){U._exec("fontname",af)});break;case"fontsize":var ac=[];g.each(s,function(ag,af){ac.push({s:'<span style="font-size:'+af.s+'">'+af.t+"("+af.s+")</span>",v:ag+1,t:af.t})});U.showMenu(ac,function(af){U._exec("fontsize",af)});break;case"fontcolor":U.showColor(function(af){U._exec("forecolor",af)});break;case"backcolor":U.showColor(function(af){if(o){U._exec("backcolor",af)}else{U.setCSS(true);U._exec("hilitecolor",af);U.setCSS(false)}});break;case"align":U.showMenu(e,function(af){U._exec(af)});break;case"list":U.showMenu(f,function(af){U._exec(af)});break;case"link":U.showLink();break;case"img":U.showImg();break;case"flash":U.showFlash();break;case"media":U.showMeida();break;case"emot":U.showEmot();break;case"html":U.toggleHtml();break;case"preview":U.togglePreview();break;case"fullscreen":U.toggleFullscreen();break;case"about":U.showAbout();break;default:U._exec(ae);break}};this._exec=function(ab,ac){if(ac!=undefined){return E.execCommand(ab,false,ac)}else{return E.execCommand(ab,false,null)}}};g(function(){g("textarea.xheditor").xhEditor(true)})})(jQuery);